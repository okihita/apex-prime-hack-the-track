<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Circuit Overlay</title>
    <style>
        body { margin: 0; font-family: monospace; }
        canvas { display: block; }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.9);
            padding: 10px;
            border-radius: 5px;
        }
        button {
            margin: 5px;
            padding: 8px;
            background: #333;
            color: white;
            border: 1px solid #666;
            cursor: pointer;
        }
        button:hover { background: #555; }
    </style>
</head>
<body>
    <div id="controls">
        <div>Toggle visibility:</div>
        <button id="toggleImage">Hide Image</button>
        <button id="toggleTrack">Hide Track</button>
        <div style="margin-top: 10px;">Track Color:</div>
        <button onclick="changeColor(0xff0000)">Red</button>
        <button onclick="changeColor(0x00ff00)">Green</button>
        <button onclick="changeColor(0x0000ff)">Blue</button>
        <button onclick="changeColor(0xffff00)">Yellow</button>
        <button onclick="changeColor(0xff00ff)">Magenta</button>
        <button onclick="changeColor(0x00ffff)">Cyan</button>
        <button onclick="changeColor(0xffffff)">White</button>
    </div>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a0a);
        
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.set(0, 600, 0);
        camera.lookAt(0, 0, 0);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        
        let imagePlane, trackLine;
        
        // Load reference image
        const textureLoader = new THREE.TextureLoader();
        textureLoader.load('source/images/Barber_Circuit_Map.png', (texture) => {
            const img = texture.image;
            const aspect = img.width / img.height;
            
            // Make plane larger to show full page
            const height = 700;
            const width = 700 * aspect;
            
            const planeGeometry = new THREE.PlaneGeometry(width, height);
            const planeMaterial = new THREE.MeshBasicMaterial({ 
                map: texture,
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.8
            });
            imagePlane = new THREE.Mesh(planeGeometry, planeMaterial);
            imagePlane.rotation.x = -Math.PI / 2;
            imagePlane.position.y = 0;
            scene.add(imagePlane);
            
            console.log('Image:', img.width, 'x', img.height, 'aspect:', aspect);
            console.log('Plane size:', width, 'x', height);
        });
        
        // Load track GLTF
        const loader = new GLTFLoader();
        loader.load('output/Barber.gltf', (gltf) => {
            trackLine = gltf.scene.children[0];
            if (trackLine) {
                trackLine.material = new THREE.LineBasicMaterial({ 
                    color: 0xff0000,
                    linewidth: 5
                });
                trackLine.position.y = 1; // Slightly above image
                scene.add(gltf.scene);
                
                const positions = trackLine.geometry.attributes.position.array;
                console.log('Track loaded:', positions.length / 3, 'points');
                console.log('First point:', positions[0], positions[1], positions[2]);
                console.log('Last point:', positions[positions.length-3], positions[positions.length-2], positions[positions.length-1]);
            }
        });
        
        // Toggle buttons
        document.getElementById('toggleImage').onclick = () => {
            if (imagePlane) {
                imagePlane.visible = !imagePlane.visible;
                document.getElementById('toggleImage').textContent = 
                    imagePlane.visible ? 'Hide Image' : 'Show Image';
            }
        };
        
        document.getElementById('toggleTrack').onclick = () => {
            if (trackLine) {
                trackLine.visible = !trackLine.visible;
                document.getElementById('toggleTrack').textContent = 
                    trackLine.visible ? 'Hide Track' : 'Show Track';
            }
        };
        
        window.changeColor = (color) => {
            if (trackLine) {
                trackLine.material.color.setHex(color);
            }
        };
        
        scene.add(new THREE.AmbientLight(0xffffff, 1));
        
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        animate();
    </script>
</body>
</html>
